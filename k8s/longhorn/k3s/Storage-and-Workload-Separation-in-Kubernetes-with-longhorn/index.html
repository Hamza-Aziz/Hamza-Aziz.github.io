<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Storage and Workload Separation in Kubernetes with Longhorn - Hamza aziz</title>
<meta name="description" content="Context Let’s say you have a k8s or a k3s cluster composed of 6 worker nodes, and for some reasons, you want to separate compute from storage in a way that some worker nodes run only Longhorn pods and take care of storage (volumes, replicas), while the rest of the worker nodes run any other pods and use the volumes that are on the other worker nodes.">


  <meta name="author" content="Hamza aziz">
  
  <meta property="article:author" content="Hamza aziz">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Hamza aziz">
<meta property="og:title" content="Storage and Workload Separation in Kubernetes with Longhorn">
<meta property="og:url" content="https://hamza-aziz.github.io/k8s/longhorn/k3s/Storage-and-Workload-Separation-in-Kubernetes-with-longhorn/">


  <meta property="og:description" content="Context Let’s say you have a k8s or a k3s cluster composed of 6 worker nodes, and for some reasons, you want to separate compute from storage in a way that some worker nodes run only Longhorn pods and take care of storage (volumes, replicas), while the rest of the worker nodes run any other pods and use the volumes that are on the other worker nodes.">







  <meta property="article:published_time" content="2024-03-28T13:39:00+00:00">





  

  


<link rel="canonical" href="https://hamza-aziz.github.io/k8s/longhorn/k3s/Storage-and-Workload-Separation-in-Kubernetes-with-longhorn/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Hamza aziz",
      "url": "https://hamza-aziz.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hamza aziz Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Hamza aziz
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/index.html">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/achievements/">Achievements</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Archive</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://hamza-aziz.github.io/">
        <img src="/assets/images/hamza-aziz-photo.png" alt="Hamza aziz" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://hamza-aziz.github.io/" itemprop="url">Hamza aziz</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>DevOps Engineer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Morocco / Germany</span>
        </li>
      

      
        
          
            <li><a href="mailto:azizhamza411@gmail.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
            <li><a href="https://github.com/Hamza-Aziz/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Storage and Workload Separation in Kubernetes with Longhorn">
    <meta itemprop="description" content="ContextLet’s say you have a k8s or a k3s cluster composed of 6 worker nodes, and for some reasons, you want to separate compute from storage in a way that some worker nodes run only Longhorn pods and take care of storage (volumes, replicas), while the rest of the worker nodes run any other pods and use the volumes that are on the other worker nodes.">
    <meta itemprop="datePublished" content="2024-03-28T13:39:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://hamza-aziz.github.io/k8s/longhorn/k3s/Storage-and-Workload-Separation-in-Kubernetes-with-longhorn/" class="u-url" itemprop="url">Storage and Workload Separation in Kubernetes with Longhorn
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2024-03-28T13:39:00+00:00">March 28, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <h1 id="context">Context</h1>
<p>Let’s say you have a k8s or a k3s cluster composed of 6 worker nodes, and for some reasons, you want to separate compute from storage in a way that some worker nodes run only <code class="language-plaintext highlighter-rouge">Longhorn</code> pods and take care of storage (volumes, replicas), while the rest of the worker nodes run any other pods and use the volumes that are on the other worker nodes.</p>

<p>For example, you want the worker nodes <code class="language-plaintext highlighter-rouge">node-1</code> and <code class="language-plaintext highlighter-rouge">node-2</code> to run only <code class="language-plaintext highlighter-rouge">Longhorn</code> pods and create volumes that are ready to be consumed, and the worker nodes <code class="language-plaintext highlighter-rouge">node-3</code>, <code class="language-plaintext highlighter-rouge">node-4</code>, <code class="language-plaintext highlighter-rouge">node-5</code>, <code class="language-plaintext highlighter-rouge">node-6</code> have no volumes on their disks, only workload pods, and consume the volumes from the worker nodes <code class="language-plaintext highlighter-rouge">node-1</code> and <code class="language-plaintext highlighter-rouge">node-2</code>. How do you do that?</p>

<h2 id="how">How</h2>
<p>You can make this on an existing <code class="language-plaintext highlighter-rouge">Longhorn</code> or on a newly installed one.</p>

<p>Let’s start:</p>

<p>We call the worker nodes <code class="language-plaintext highlighter-rouge">node-1</code> and <code class="language-plaintext highlighter-rouge">node-2</code>, the storage nodes and the worker nodes <code class="language-plaintext highlighter-rouge">node-3</code>, <code class="language-plaintext highlighter-rouge">node-4</code>, <code class="language-plaintext highlighter-rouge">node-5</code>, <code class="language-plaintext highlighter-rouge">node-6</code> the compute nodes.</p>

<h3 id="configure-the-storage-nodes">Configure the storage nodes</h3>

<ol>
  <li>
    <p>Label the storage nodes with the label <code class="language-plaintext highlighter-rouge">node.longhorn.io/create-default-disk=true</code>.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl label nodes node-1 node-2 node.longhorn.io/create-default-disk=true
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install <code class="language-plaintext highlighter-rouge">Longhorn</code> with the setting “Create Default Disk on Labeled Nodes” set to true.</p>

    <p>if you’re using Helm to install <code class="language-plaintext highlighter-rouge">longhron</code> you can set that value using :</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> defaultSettings:
   # -- Setting that allows Longhorn to automatically create a default disk only on nodes with the label "node.longhorn.io/create-default-disk=true" (if no other disks exist). When this setting is disabled, Longhorn creates a default disk on each node that is added to the cluster.
   createDefaultDiskLabeledNodes: true
</code></pre></div>    </div>

    <p>If you’re using another method, have a look at how to configure this setting, see <a href="https://longhorn.io/docs/archives/1.2.2/references/settings/#create-default-disk-on-labeled-nodes">https://longhorn.io/docs/archives/1.2.2/references/settings/#create-default-disk-on-labeled-nodes</a></p>
  </li>
</ol>

<p>Now, if you go to the <code class="language-plaintext highlighter-rouge">Longhorn</code> dashboard, you’ll see that the compute nodes are disabled and have no disk.</p>

<p>📝📌 PS: If you’ve already installed <code class="language-plaintext highlighter-rouge">Longhorn</code> and want to configure this setting on a working <code class="language-plaintext highlighter-rouge">Longhorn</code>, you need to remove the compute nodes from the cluster and bring them back again to have this take effect.</p>

<h3 id="rejecting-no-longhron-pods-from-being-scheduled-on-the-storage-nodes">Rejecting no Longhron pods from being scheduled on the storage nodes</h3>

<p>The current changes we made will only tell <code class="language-plaintext highlighter-rouge">Longhorn</code> to stop using the compute nodes for storage but will not restrict all the pods except <code class="language-plaintext highlighter-rouge">Longhorn</code>’s pods from being scheduled on the storage nodes. Taint and toleration to the rescue!</p>

<p><code class="language-plaintext highlighter-rouge">Longhorn</code> components can be configured to tolerate taints. So, the idea is to taint the storage nodes and make only the <code class="language-plaintext highlighter-rouge">Longhorn</code> pods tolerate these taints. This will result in allowing only the <code class="language-plaintext highlighter-rouge">Longhorn</code> pods to be scheduled on the storage nodes and rejecting any other pod.</p>

<ol>
  <li>
    <p>Apply the taint on the storage nodes</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl taint nodes node-1 node-2 node=storage:NoSchedule
</code></pre></div>    </div>
  </li>
  <li>
    <p>Make the Longhorn pods tolerate the taint</p>

    <p>Just to not make this article long, depending on whether you installed <code class="language-plaintext highlighter-rouge">Longhorn</code> or are planning to install it and with which method, steps differ. So, follow up on the blog depending on your case. Link <a href="https://longhorn.io/docs/archives/1.2.2/advanced-resources/deploy/taint-toleration/#setting-up-taints-and-tolerations-after-longhorn-has-been-installed">https://longhorn.io/docs/archives/1.2.2/advanced-resources/deploy/taint-toleration/#setting-up-taints-and-tolerations-after-longhorn-has-been-installed</a>.</p>
  </li>
</ol>

<p><strong>Tips</strong>: If you’re trying this on an installed <code class="language-plaintext highlighter-rouge">Longhorn</code>, one of the steps in the link I provided is asking to make all volumes detached. An easy way is to run this command for every namespace you have:</p>

<ul>
  <li>
    <p>This will scale down all deployments to 0 in the namespace my-namespace.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale deployment -n my-namespace --replicas=0 --all
</code></pre></div>    </div>
  </li>
  <li>This will scale down all stateful sets to 0 in the namespace my-namespace.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale statefulset -n my-namespace --replicas=0 --all
</code></pre></div>    </div>
  </li>
  <li>
    <p>When the setting is configured, you can bring them back by (if the replica count was 1 ofc):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale deployment -n my-namespace --replicas=1 --all
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale statefulset -n my-namespace --replicas=1 --all
</code></pre></div>    </div>
  </li>
</ul>

<p>Now, you have node 1 and node 2 responsible only for storing volumes and replicas and nothing else, and nodes 3, 4, and 5 responsible only for your workload pods.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#k3s" class="page__taxonomy-item p-category" rel="tag">k3s</a><span class="sep">, </span>
    
      <a href="/categories/#k8s" class="page__taxonomy-item p-category" rel="tag">k8s</a><span class="sep">, </span>
    
      <a href="/categories/#longhorn" class="page__taxonomy-item p-category" rel="tag">longhorn</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2024-03-28T13:39:00+00:00">March 28, 2024</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Storage+and+Workload+Separation+in+Kubernetes+with+Longhorn%20https%3A%2F%2Fhamza-aziz.github.io%2Fk8s%2Flonghorn%2Fk3s%2FStorage-and-Workload-Separation-in-Kubernetes-with-longhorn%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fhamza-aziz.github.io%2Fk8s%2Flonghorn%2Fk3s%2FStorage-and-Workload-Separation-in-Kubernetes-with-longhorn%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fhamza-aziz.github.io%2Fk8s%2Flonghorn%2Fk3s%2FStorage-and-Workload-Separation-in-Kubernetes-with-longhorn%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/linux/Hardlink-vs-softlink/" class="pagination--pager" title="Hardlink vs Softlink
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="utterances-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/linux/Hardlink-vs-softlink/" rel="permalink">Hardlink vs Softlink
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-26T17:20:00+00:00">February 26, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In this article, we’ll talk about the difference between soft links and hard links, they might sounds simple and easy (in fact they are) but many engineers s...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/terraform/Terraform-workspace-terragrunt/" rel="permalink">Managing Multiple Environments using Terraform Workspace vs Folders vs Terragrunt
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-23T16:20:00+00:00">February 23, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
As your infrastructure grows, managing multiple environments (such as development, staging, and production) can become challenging. In this blog post, we’ll...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/k8s/kube-proxy-cni-plugin-in-k8s/" rel="permalink">Kubernetes CNI plugin vs Kube-proxy
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-14T16:20:00+00:00">February 14, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Before discussing the difference between the two components, let’s take a second to define the CNI,
What is the CNI ?
CNI (Container Network Interface),is a ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/terraform/aws/understand-terraform-import-wiht-aws/" rel="permalink">Understand Terraform import with AWS IAM users and groups
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-11-27T18:49:42+00:00">November 27, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">How to import a resource created manually under Terraform management
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    <!-- 
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
     -->
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Hamza aziz. All Rights Reserved.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'Hamza-Aziz/Hamza-Aziz.github.io');
    script.setAttribute('issue-term', 'pathname');
    
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  





  </body>
</html>
